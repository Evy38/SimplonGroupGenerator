<!-- Titre de la page -->
<header class="page-header">
  <h1>Mes Groupes</h1>
</header>

<!-- Liste des cartes de groupe -->
<div class="group-cards-container" [class.blurred]="isCreateGroupModalOpen || isMembersModalOpen || isConfirmDeleteModalOpen"> <!-- Flou si une modale est ouverte -->
  @for (group of groups; track group.id) {
    <div class="group-card">
      <div class="group-card-image-link-wrapper" (click)="openMembersModal(group)">
        <div class="group-card-image">
          <img [src]="group.imageUrl" [alt]="'Image pour ' + group.name">
        </div>
        <div class="group-card-content">
          <h3 class="group-name">{{ group.name }}</h3>
          <p class="group-members-count">{{ group.members.length }} membre(s)</p>
        </div>
      </div>
      <div class="group-card-actions">
        <button type="button" class="icon-button edit-button" title="Modifier le groupe" (click)="openEditGroupModal(group); $event.stopPropagation();">
          <img src="assets/pen.png" alt="Modifier"> <!-- Assure-toi que ces images existent -->
        </button>
        <button type="button" class="icon-button delete-button" title="Supprimer le groupe" (click)="confirmDeleteGroup(group); $event.stopPropagation();">
          <img src="assets/trash.png" alt="Supprimer"> <!-- Assure-toi que ces images existent -->
        </button>
      </div>
    </div>
  } @empty {
    <p class="empty-list-message">Vous n'avez pas encore de groupes. Commencez par en créer un !</p>
  }
</div>

<!-- Bouton "+" flottant -->
<button type="button" class="fab-button" (click)="openCreateGroupModal()" title="Créer un nouveau groupe">
  +
</button>

<!-- MODALE DE CRÉATION / MODIFICATION DE GROUPE -->
<!-- C'est cette modale qui est contrôlée par isCreateGroupModalOpen -->
@if (isCreateGroupModalOpen) {
  <div class="modal-overlay full-screen-modal-overlay" (click)="closeCreateGroupModal()">
    <div class="modal-content large-modal-content" (click)="$event.stopPropagation()">
      <button class="modal-close-button" (click)="closeCreateGroupModal()" aria-label="Fermer la modale">×</button>

      <div class="modal-header">
        <!-- Le titre change en fonction du mode (isEditMode) -->
        <h2>{{ isEditMode ? 'Modifier le Groupe' : 'Créer un ou plusieurs Groupe(s)' }}</h2>
      </div>

      <form class="modal-form create-group-form" (ngSubmit)="onCreateGroupSubmit()">


        <!-- Champs pour les noms de chaque groupe -->
        @for (groupName of newGroupData.groupNames; track $index; let i = $index) {
          <!-- En mode édition, on ne montre que le premier champ de nom -->
          @if (!isEditMode || (isEditMode && i === 0)) {
            <div class="form-group">
              <label for="group-name-{{i}}">
                {{ isEditMode ? 'Nom du Groupe :' : 'Nom du Groupe ' + (i + 1) + ':' }}
              </label>
              <input type="text" id="group-name-{{i}}" name="groupName{{i}}" placeholder="Ex: Équipe {{ i + 1 }}" required
                     [(ngModel)]="newGroupData.groupNames[i]">
            </div>
          }
        }

        <!-- NOUVEAU CHAMP POUR L'URL DE L'IMAGE -->
        <div class="form-group">
          <label for="group-creation-imageurl">URL de l'image (optionnel) :</label>
          <input type="url" id="group-creation-imageurl" name="groupCreationImageUrl" placeholder="https://exemple.com/image.jpg"
                 [(ngModel)]="newGroupData.imageUrl"> <!-- Lié à newGroupData.imageUrl -->
        </div>

        <!-- SECTION POUR GÉRER LES MEMBRES DU GROUPE EN COURS DE CRÉATION/ÉDITION -->
        <div class="form-section">
          <h4>Membres {{ isEditMode ? 'du groupe' : 'pour le(s) nouveau(x) groupe(s)' }} :</h4>
          @if (selectedPeopleForNewGroup.length > 0) {
            <ul class="current-members-list">
              @for (person of selectedPeopleForNewGroup; track person.id) {
                <li>
                  <span>{{ person.nom }} ({{person.email || 'email non défini'}})</span>
                  <!-- Bouton pour retirer la personne de la sélection actuelle -->
                  <button type="button" class="remove-person-btn" (click)="removePersonFromCurrentGroupSelection(person)" title="Retirer {{person.nom}}">×</button>
                </li>
              }
            </ul>
          } @else {
            <p class="info-text">Aucune personne sélectionnée.</p>
          }

          <hr class="form-divider">

           <div class="add-person-input-section">
            <h5>Ajouter une personne par nom ou email :</h5>
            <div class="form-group inline-form-group">
              <input type="text" id="add-person-input" name="addPersonInput"
                     placeholder="Nom ou email de la personne"
                     [(ngModel)]="newPersonInput"
                     (keyup.enter)="addPersonFromInput()">
              <button type="button" class="button-add-person" (click)="addPersonFromInput()">Ajouter</button>
            </div>
          </div>

          <h5>Ajouter depuis les personnes disponibles :</h5>
          <div class="available-people-list modal-available-people">
            @for(person of availablePeople; track person.id) {
              @if (!isPersonSelected(person)) {
                <div class="person-item add-person-item" (click)="togglePersonSelection(person)">
                  + {{ person.nom }} ({{ person.email }})
                </div>
              }
            } @empty {
              <p>Toutes les personnes disponibles sont déjà dans le groupe ou aucune personne n'est disponible.</p>
            }
          </div>
        </div>

        @if (registerError) { <p class="error-message">{{ registerError }}</p> }
        @if (registerSuccess) { <p class="success-message">{{ registerSuccess }}</p> }

        <div class="buttons modal-buttons">
          <button type="button" class="button-secondary" (click)="closeCreateGroupModal()">Annuler</button>
          <button type="submit" class="button-primary">{{ isEditMode ? 'Enregistrer Modifications' : 'Créer Groupe(s)' }}</button>
        </div>
      </form>
    </div>
  </div>
} <!-- Fin de la modale de création/modification -->


<!-- MODALE POUR AFFICHER LES MEMBRES DU GROUPE -->
@if (isMembersModalOpen && selectedGroupForMembers) {
  <div class="modal-overlay members-modal-overlay" (click)="closeMembersModal()">
    <div class="modal-content members-modal-content" (click)="$event.stopPropagation()">
      <button class="modal-close-button" (click)="closeMembersModal()" aria-label="Fermer la modale">×</button>
      <div class="modal-header">
        <h2>Membres du groupe : {{ selectedGroupForMembers.name }}</h2>
      </div>
      <div class="modal-body members-list">
        @if (selectedGroupForMembers.members && selectedGroupForMembers.members.length > 0) {
          <ul>
            @for (member of selectedGroupForMembers.members; track member.id) {
              <li>
                <span class="member-name">{{ member.nom }}</span>
                @if (member.email) { <span class="member-detail"> - {{ member.email }}</span> }
                @if (member.role) { <span class="member-detail"> ({{ member.role }})</span> }
                @if (member.genre) { <span class="member-detail"> Genre: {{member.genre}}</span> }
                @if (member.niveauTechnique) { <span class="member-detail"> N.Tech: {{member.niveauTechnique}}</span> }
              </li>
            }
          </ul>
        } @else {
          <p>Aucun membre dans ce groupe.</p>
        }
      </div>
      <div class="modal-footer buttons">
        <button type="button" class="button-secondary" (click)="closeMembersModal()">Fermer</button>
      </div>
    </div>
  </div>
} <!-- Fin de la modale des membres -->

<!-- MODALE DE CONFIRMATION DE SUPPRESSION -->
@if (isConfirmDeleteModalOpen && groupToDelete) {
  <div class="modal-overlay confirm-delete-modal-overlay" (click)="closeConfirmDeleteModal()">
    <div class="modal-content confirm-delete-modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirmer la Suppression</h2>
      </div>
      <div class="modal-body">
        <p>Êtes-vous sûr de vouloir supprimer le groupe "<strong>{{ groupToDelete.name }}</strong>" ?</p>
        <p class="warning-text">Cette action est irréversible.</p>
      </div>
      <div class="modal-footer buttons confirm-delete-buttons">
        <button type="button" class="button-secondary" (click)="closeConfirmDeleteModal()">Annuler</button>
        <button type="button" class="button-danger" (click)="deleteGroup()">Supprimer</button>
      </div>
    </div>
  </div>
} <!-- Fin de la modale de confirmation de suppression -->