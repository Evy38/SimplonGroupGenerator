<!-- src/app/features/formateur/brief-detail/brief-detail.component.html -->
<!-- MODIFICATION: Utiliser viewData$ avec le pipe async -->
@if (viewData$ | async; as data) {
  <!-- SECTION HEADER: Affiche les détails du brief -->
  <header class="page-header brief-detail-header">
    <a routerLink="/formateur/briefs" class="back-to-list-link">← Retour à la liste des briefs</a>
    <h1>{{ data.brief.name }}</h1>
  
    <p class="brief-detail-description">{{ data.brief.description }}</p>
    <p class="brief-promo-info">
      <em>Promo associée :
        <strong>
          {{ data.sourceGroup.name }}
        </strong>
        @if (data.sourceGroup.members) {
          ({{ data.sourceGroup.members.length }} personnes)
        }
      </em>
    </p>
  </header>

  <!-- SECTION AFFICHAGE DES GROUPES DE TRAVAIL GÉNÉRÉS -->
  <section class="generated-work-groups-section">
    <h2>Sous-Groupes de Travail Générés</h2>
    @if (generatedWorkGroups.length > 0) { <!-- generatedWorkGroups est toujours géré localement -->
      <div class="work-group-list-container">
        @for (group of generatedWorkGroups; track group.id) {
          <div class="work-group-card">
            <div class="work-group-header" (click)="openWorkGroupMembersModal(group, $event)" title="Voir les membres de {{group.name}}">
              <h4 class="work-group-name">{{ group.name }}</h4>
              <div class="work-group-actions">
                <button type="button" class="icon-button simple-edit-button" title="Modifier ce sous-groupe"
                        (click)="openEditWorkGroupModal(group, $event)">
                    <img src="assets/pen.png" alt="Modifier">
                </button>
                <button type="button" class="icon-button simple-delete-button" title="Supprimer ce sous-groupe"
                        (click)="openDeleteWorkGroupConfirmModal(group, $event)">
                    <img src="assets/trash.png" alt="Supprimer">
                </button>
              </div>
            </div>
            <ul class="work-group-members-list" (click)="openWorkGroupMembersModal(group, $event)" title="Voir les membres de {{group.name}}">
              @for (member of group.members; track member.id; let count = $count) {
                @if ($index < 3) {
                  <li class="member-name-item">{{ member.nom }}</li>
                }
              }
              @if (group.members.length > 3) {
                <li class="member-name-item more-members">... et {{ group.members.length - 3 }} autre(s)</li>
              }
            </ul>
             @if (group.members.length === 0) {
                <p class="no-members-in-card">Aucun membre</p>
             }
          </div>
        }
      </div>
    } @else {
      <p class="empty-list-message">Aucun sous-groupe de travail généré. Cliquez sur le dé pour commencer !</p>
    }
  </section>

  <!-- BOUTON FLOTTANT "DÉ" pour la génération -->
  <!-- S'assurer que data.brief et data.sourceGroup existent avant d'afficher le bouton ou de l'activer -->
  <button type="button" class="fab-button dice-fab" (click)="openGenerateGroupsModal()" title="Générer des sous-groupes de travail">
    <img src="assets/dés.png" alt="Générer groupes">
  </button>


  <!-- MODALE DE GÉNÉRATION DE SOUS-GROUPES (AVEC LE "DÉ") -->
  <!-- data.brief et data.sourceGroup viennent de viewData$ | async -->
  @if (isGenerateGroupsModalOpen && data.brief && data.sourceGroup) {
    <div class="modal-overlay full-screen-modal-overlay" (click)="closeGenerateGroupsModal()">
      <div class="modal-content large-modal-content generate-groups-modal" (click)="$event.stopPropagation()">
        <button class="modal-close-button" (click)="closeGenerateGroupsModal()" aria-label="Fermer">×</button>
        <div class="modal-header">
          <h2>Générer des Sous-Groupes pour "{{ data.brief.name }}"</h2>
          <p>À partir de la promo : <strong>{{ data.sourceGroup.name }}</strong> ({{data.sourceGroup.members.length || 0}} personnes)</p>
        </div>
        <form class="modal-form" (ngSubmit)="onGenerateGroupsSubmit()"> <!-- onGenerateGroupsSubmit utilisera this.sourceGroupForBrief -->
          <div class="form-group">
            <label for="gen-people-per-group">Nombre de personnes par sous-groupe :</label>
            <input type="number" id="gen-people-per-group" name="genPeoplePerGroup"
                   [(ngModel)]="generationCriteria.peoplePerGroup" min="1" [max]="data.sourceGroup.members.length || 1" required>
          </div>
          <!-- ... reste des critères de la modale de génération ... -->
          <h4 class="criteria-title">Critères de Mixité :</h4>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="critere-dwwm" name="critereDwwm" [(ngModel)]="generationCriteria.mixAncienDWWM">
            <label for="critere-dwwm">Mixer les anciens DWWM</label>
          </div>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="critere-genre" name="critereGenre" [(ngModel)]="generationCriteria.mixGenre">
            <label for="critere-genre">Mixer les genres</label>
          </div>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="critere-francais" name="critereFrancais" [(ngModel)]="generationCriteria.mixAisanceFrancais">
            <label for="critere-francais">Mixer par aisance en Français</label>
          </div>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="critere-tech" name="critereTech" [(ngModel)]="generationCriteria.mixNiveauTechnique">
            <label for="critere-tech">Mixer par niveau technique</label>
          </div>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="critere-profil" name="critereProfil" [(ngModel)]="generationCriteria.mixProfil">
            <label for="critere-profil">Mixer les profils</label>
          </div>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="critere-age" name="critereAge" [(ngModel)]="generationCriteria.mixAge">
            <label for="critere-age">Mixer les âges</label>
          </div>
          @if (generationError) { <p class="error-message">{{ generationError }}</p> }
          <div class="buttons modal-buttons">
            <button type="button" class="button-secondary" (click)="closeGenerateGroupsModal()">Annuler</button>
            <button type="submit" class="button-primary">Générer les Sous-Groupes</button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- MODALE POUR AFFICHER LES MEMBRES D'UN SOUS-GROUPE DE TRAVAIL -->
  <!-- selectedWorkGroupForMembers est toujours géré localement -->
  @if (isMembersModalOpen && selectedWorkGroupForMembers) {
    <!-- ... Contenu de la modale des membres ... (pas de changement ici car elle dépend de selectedWorkGroupForMembers) -->
    <div class="modal-overlay members-modal-overlay" (click)="closeWorkGroupMembersModal()">
      <div class="modal-content members-modal-content" (click)="$event.stopPropagation()">
        <button class="modal-close-button" (click)="closeWorkGroupMembersModal()" aria-label="Fermer">×</button>
        <div class="modal-header">
          <h2>Membres du sous-groupe : {{ selectedWorkGroupForMembers.name }}</h2>
        </div>
        <div class="modal-body members-list-body">
          @if (selectedWorkGroupForMembers.members && selectedWorkGroupForMembers.members.length > 0) {
            <ul class="members-ul">
              @for (member of selectedWorkGroupForMembers.members; track member.id) {
                <li class="member-item">
                  <span class="member-name">{{ member.nom }}</span>
                  <div class="member-details">
                    @if (member.email) { <span class="member-detail">Email: {{ member.email }}</span> }
                    @if (member.genre) { <span class="member-detail">Genre: {{member.genre}}</span> }
                    @if (member.aisanceFrancais) { <span class="member-detail">Français: N{{member.aisanceFrancais}}</span> }
                    @if (member.ancienDWWM !== undefined) { <span class="member-detail">Ancien DWWM: {{member.ancienDWWM ? 'Oui' : 'Non'}}</span> }
                    @if (member.niveauTechnique) { <span class="member-detail">N. Tech: N{{member.niveauTechnique}}</span> }
                    @if (member.profil) { <span class="member-detail">Profil: {{member.profil}}</span> }
                    @if (member.age) { <span class="member-detail">Âge: {{member.age}}</span> }
                  </div>
                </li>
              }
            </ul>
          } @else {
            <p>Aucun membre dans ce sous-groupe.</p>
          }
        </div>
        <div class="modal-footer buttons">
          <button type="button" class="button-secondary" (click)="closeWorkGroupMembersModal()">Fermer</button>
        </div>
      </div>
    </div>
  }

  <!-- MODALE DE MODIFICATION D'UN SOUS-GROUPE DE TRAVAIL -->
  <!-- Utiliser data.sourceGroup pour getAvailablePeopleForEditingGroup -->
  @if (isEditWorkGroupModalOpen && selectedWorkGroupToEdit && editableWorkGroupData && data.sourceGroup) {
    <!-- ... Contenu de la modale d'édition ... (pas de changement majeur ici, mais s'assurer que getAvailablePeopleForEditingGroup() a accès à data.sourceGroup si besoin) -->
     <div class="modal-overlay" (click)="closeEditWorkGroupModal()">
      <div class="modal-content large-modal-content" (click)="$event.stopPropagation()">
        <button class="modal-close-button" (click)="closeEditWorkGroupModal()" aria-label="Fermer">×</button>
        <div class="modal-header">
          <h2>Modifier le Sous-Groupe : {{ editableWorkGroupData.name }}</h2>
        </div>
        <form class="modal-form" (ngSubmit)="onSaveWorkGroupChanges()">
          <div class="form-group">
            <label for="edit-group-name">Nom du Sous-Groupe :</label>
            <input type="text" id="edit-group-name" name="editGroupName" required [(ngModel)]="editableWorkGroupData.name">
          </div>
          <h4>Membres Actuels :</h4>
          @if (editableWorkGroupData.members.length > 0) {
            <ul class="current-members-in-modal-list">
              @for (member of editableWorkGroupData.members; track member.id) {
                <li>
                  <span>{{ member.nom }} <em>({{ member.profil || 'N/A' }}, N.Tech: {{member.niveauTechnique || 'N/A'}})</em></span>
                  <button type="button" class="remove-member-button" (click)="removeMemberFromEditableGroup(member)" title="Retirer {{member.nom}}">×</button>
                </li>
              }
            </ul>
          } @else {
            <p>Ce sous-groupe n'a actuellement aucun membre.</p>
          }
          <hr class="form-divider">
          <div class="add-person-input-section">
            <h5>Ajouter une personne de la promo "{{ data.sourceGroup.name }}" par nom ou email :</h5>
            <div class="form-group inline-form-group">
              <input type="text" id="add-person-input" name="addPersonInput"
                     placeholder="Nom ou email de la personne"
                     [(ngModel)]="newPersonInput"
                     (keyup.enter)="addPersonFromInput()">
              <button type="button" class="button-add-person" (click)="addPersonFromInput()">Ajouter</button>
            </div>
          </div>
          <h5>Ou ajouter depuis la liste des personnes disponibles de la promo :</h5>
          <div class="available-people-for-edit-list">
            @for (person of getAvailablePeopleForEditingGroup(); track person.id) {
              <div class="person-item-to-add" (click)="addPersonToEditableGroup(person)" title="Ajouter {{person.nom}}">
                + {{ person.nom }} (Profil: {{person.profil || 'N/A'}}, N.Tech: {{person.niveauTechnique || 'N/A'}})
              </div>
            } @empty {
              <p>Toutes les personnes de la promo sont déjà dans ce sous-groupe.</p>
            }
          </div>
          @if (editWorkGroupError) { <p class="error-message">{{ editWorkGroupError }}</p> }
          <div class="buttons modal-buttons">
            <button type="button" class="button-secondary" (click)="closeEditWorkGroupModal()">Annuler</button>
            <button type="submit" class="button-primary">Enregistrer Modifications</button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- MODALE DE CONFIRMATION DE SUPPRESSION D'UN SOUS-GROUPE DE TRAVAIL -->
  <!-- workGroupToDelete est toujours géré localement -->
  @if (isDeleteWorkGroupConfirmModalOpen && workGroupToDelete) {
    <!-- ... Contenu de la modale de suppression de sous-groupe ... (pas de changement ici) -->
    <div class="modal-overlay confirm-delete-modal-overlay" (click)="closeDeleteWorkGroupConfirmModal()">
      <div class="modal-content confirm-delete-modal-content" (click)="$event.stopPropagation()">
        <button class="modal-close-button" (click)="closeDeleteWorkGroupConfirmModal()" aria-label="Fermer">×</button>
        <div class="modal-header">
          <h2>Confirmer la Suppression</h2>
        </div>
        <div class="modal-body">
          <p>Êtes-vous sûr de vouloir supprimer le sous-groupe "<strong>{{ workGroupToDelete.name }}</strong>" ?</p>
          <p class="warning-text">Cette action est irréversible.</p>
        </div>
        <div class="modal-footer buttons confirm-delete-buttons">
          <button type="button" class="button-secondary" (click)="closeDeleteWorkGroupConfirmModal()">Annuler</button>
          <button type="button" class="button-danger" (click)="confirmDeleteWorkGroup()">Oui, Supprimer</button>
        </div>
      </div>
    </div>
  }

} @else {
  <p class="loading-message">Chargement des détails du brief ou brief non trouvé...</p>
}